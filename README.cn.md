# Nyaruko Telegram æœºå™¨äºº

æ¬¢è¿æ¥åˆ°å……æ»¡å¼‚åŸŸé£æƒ…çš„ `Nyaruko` Telegram æœºå™¨äººé¡¹ç›®ï¼ğŸŒŸ è¿™æ˜¯ä¸€ä¸ªä¸ä¼—ä¸åŒçš„ Telegram æœºå™¨äººï¼Œéƒ¨ç½²åœ¨æ€§èƒ½å“è¶Šçš„ Cloudflare Workers ä¸Šã€‚æˆ‘ä»¬çš„ Nyaruko ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæœºå™¨äººï¼Œæ›´æ˜¯ Niracler çš„ç²¾çµä¼™ä¼´ï¼Œéšæ—¶å‡†å¤‡æ‰§è¡Œå„ç§å¥‡å¦™è€Œç‹¬ç‰¹çš„ä»»åŠ¡ã€‚å°±åƒã€Šæ½œè¡Œå§ã€å¥ˆäºšå­ï¼ï¼ï¼ã€‹ä¸­çš„å¥³ä¸»è§’å¥ˆäºšå­ä¸€æ ·ï¼Œè¿™ä¸ªæœºå™¨äººçµæ„Ÿæ¥æºäºå…‹è‹é²ç¥è¯ï¼Œå¥‡è¶£æ¨ªç”Ÿã€å¤„å¤„å……æ»¡æƒŠå–œï¼ğŸ‘¾

## åŠŸèƒ½ä»‹ç»

ç›®å‰ï¼ŒNyaruko æœºå™¨äººèƒ½å¤Ÿå®ç°ä»¥ä¸‹æƒŠè‰³çš„åŠŸèƒ½ï¼š

### `/sync_xlog` - å°† Telegram ä¿¡æ¯åŒæ­¥åˆ° xLog Shorts ä¸Š

é€šè¿‡ `/sync_xlog` å‘½ä»¤ï¼ŒNyaruko å¯ä»¥å°† Telegram ä¸­çš„ä¿¡æ¯åŒæ­¥åˆ° xLog Shorts ä¸Šã€‚ä¸è¿‡å‘¢ï¼ŒNyaruko è¿˜åœ¨æˆé•¿ä¸­ï¼Œå½“å‰è¿˜ä¸æ”¯æŒåŒæ­¥ POSTã€‚

<div align=center>
	<img height="350" alt="image" src="https://github.com/niracler/nyaruko-telegram-bot/assets/24842631/db2249d7-9b5e-4cc7-9544-0a48bc9c402c">
	<img height="350" alt="image" src="https://github.com/niracler/nyaruko-telegram-bot/assets/24842631/cd6260de-cbba-460d-b2d1-08b462c91b4b">
</div>

### `/sync_twitter` - å°† Telegram ä¿¡æ¯åŒæ­¥åˆ° Twitter

åŒä¸Šï¼Œé€šè¿‡ `/sync_twitter` å‘½ä»¤ï¼ŒNyaruko å¯ä»¥å°† Telegram ä¸­çš„ä¿¡æ¯åŒæ­¥åˆ° Twitter ä¸Šã€‚

è¯¦æƒ…è¯·çœ‹ [è¿™é‡Œ](https://github.com/niracler/nyaruko-telegram-bot/pull/2), æœ‰æ›´å®Œæ•´çš„ä¾‹å­ã€‚

<div align=center>
  <img height="240" alt="image" src="https://github.com/niracler/nyaruko-telegram-bot/assets/24842631/a557d8c6-f75a-4712-9c24-cea244668acf">
  <img height="240" alt="image" src="https://github.com/niracler/nyaruko-telegram-bot/assets/24842631/da45b9dc-9d18-4f15-b6d1-a7ba2b10c74b">
</div>

### æ‰€æœ‰åŠŸèƒ½åˆ—è¡¨

- `/sync_xlog` - å°† Telegram ä¿¡æ¯åŒæ­¥åˆ° xLog ä¸Šï¼Œä»¥ Shorts çš„å½¢å¼ã€‚(æš‚ä¸æ”¯æŒåŒæ­¥ POST)
- `/sync_twitter` - å°† Telegram ä¿¡æ¯åŒæ­¥åˆ° Twitter ä¸Šã€‚
- `/ping` - æµ‹è¯•æœºå™¨äººæ˜¯å¦åœ¨çº¿ã€‚
- `/getchatid` - è·å–å½“å‰å¯¹è¯çš„ IDã€‚
- `/getuserid` - è·å–å½“å‰ç”¨æˆ·çš„ IDã€‚
- @nyaruko_aibot - å¯ä»¥è·Ÿå¥ˆäºšå­èŠå¤©å“¦ï¼

### æ›´å¤šåŠŸèƒ½æ•¬è¯·æœŸå¾…

Nyaruko çš„èƒ½åŠ›æ­£åœ¨ä¸æ–­è¿›åŒ–ä¸­ï¼Œæœªæ¥å°†ä¼šæœ‰æ›´å¤šæ¿€åŠ¨äººå¿ƒçš„åŠŸèƒ½é™†ç»­ä¸Šçº¿ã€‚

## å¦‚ä½•è¿è¡Œ Nyaruko

æƒ³è¦è®© Nyaruko åœ¨æ‚¨çš„ç¯å¢ƒä¸­æ´»è·ƒèµ·æ¥ï¼Œæ‚¨éœ€è¦æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤è¿›è¡Œé…ç½®ï¼š

1. å‡†å¤‡å¥½æ‚¨çš„ Cloudflare Workers ç¯å¢ƒã€‚
2. é…ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨ `wrangler secret` å‘½ä»¤æ¥è®¾ç½®å®ƒä»¬ã€‚
3. éƒ¨ç½² Nyaruko æœºå™¨äººåˆ° Cloudflare Workersã€‚

### å…‹éš†å¹¶è¿›å…¥é¡¹ç›®ç›®å½•

```bash
git clone https://github.com/niracler/nyaruko-telegram-bot && cd nyaruko-telegram-bot
```

### ç¯å¢ƒå˜é‡

Nyaruko éœ€è¦ä»¥ä¸‹ç¯å¢ƒå˜é‡çš„æ”¯æŒæ¥å‘æŒ¥å…¶ä½œç”¨ï¼š

|å˜é‡å|æ˜¯å¦å¿…é¡»|é…ç½®æ–¹å¼|æè¿°|
|---|---|---|---|
|`ALLOWED_USER_IDS`|æ˜¯|`wrangler.yml`|å…è®¸ä½¿ç”¨æœºå™¨äººçš„ç”¨æˆ· ID åˆ—è¡¨ï¼Œä»¥é€—å·åˆ†éš”|
|`TELEGRAM_BOT_USERNAME`|å¦|`wrangler.yml`|æ‚¨çš„ Telegram æœºå™¨äººç”¨æˆ·åï¼Œç”¨äºå¼€å¯ ai èŠå¤©åŠŸèƒ½|
|`TELEGRAM_BOT_SECRET`|æ˜¯|`secret`|æ‚¨çš„ Telegram æœºå™¨äººå¯†é’¥ï¼ˆ[è¯¦æƒ…å‚è€ƒ](https://core.telegram.org/bots#how-do-i-create-a-bot) |
|`XLOG_TOKEN`|å¦|`secret`|xLog çš„ tokenã€‚ç”¨äºå¼€å¯ xlog åŒæ­¥åŠŸèƒ½|
|`XLOG_CHARACTER_ID`|å¦|`secret`|xLog çš„ characterIdã€‚|
|`TWITTER_API_KEY`|å¦|`secret`|æ‚¨çš„ Twitter API å¯†é’¥([è¯¦æƒ…å‚è€ƒ](https://developer.twitter.com/en/portal/dashboard)), ç”¨äºå¼€å¯ twitter åŒæ­¥åŠŸèƒ½|
|`TWITTER_API_SECRET`|å¦|`secret`|æ‚¨çš„ Twitter API å¯†é’¥å¯†æ–‡|
|`TWITTER_ACCESS_TOKEN`|å¦|`secret`|Twitter çš„è®¿é—®ä»¤ç‰Œ|
|`TWITTER_ACCESS_TOKEN_SECRET`|å¦|`secret`|Twitter çš„è®¿é—®ä»¤ç‰Œå¯†æ–‡|
|`TWITTER_USER_ID`|å¦|`wrangler.yml`|æ‚¨çš„ Twitter ç”¨æˆ· ID|
|`OPENAI_API_KEY`|å¦|`secret`|OpenAI çš„ API å¯†é’¥ã€‚ç”¨äºå¼€å¯ ai èŠå¤©åŠŸèƒ½|

### å…³äºè®¾ç½®ç¯å¢ƒå˜é‡

ç¯å¢ƒå˜é‡çš„è®¾ç½®è¯·ä½¿ç”¨ Cloudflare Workers çš„ `wrangler` CLI å·¥å…·ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
wrangler secret put TELEGRAM_BOT_SECRET
# åœ¨æç¤ºåè¾“å…¥ç›¸åº”çš„å€¼

wrangler secret put TWITTER_API_KEY
# é‡å¤ä¸Šè¿°æ­¥éª¤è®¾ç½®æ‰€æœ‰éœ€è¦çš„å˜é‡
...
```

æ›´è¯¦ç»†çš„ wrangler é…ç½®å’Œå‘½ä»¤è¯´æ˜ï¼Œè¯·æŸ¥é˜… [å®˜æ–¹ wrangler æ–‡æ¡£](https://developers.cloudflare.com/workers/wrangler/commands/) (wrangler æ–‡æ¡£æ„Ÿè§‰è¦æ¯” twitter æ–‡æ¡£å¥½æ‡‚å¾—å¤šäº†ï¼Œèµ·ç äº‹ä¾‹ä¼šå¤šå¾ˆå¤šï½ï½)ã€‚

### åˆ›å»º D1 æ•°æ®åº“

å› ä¸º media_group çš„ä¿¡æ¯æ˜¯é€šè¿‡ D1 æ•°æ®åº“æ¥å­˜å‚¨çš„ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ª D1 æ•°æ®åº“

> æ³¨æ„âš ï¸ï¼šåœ¨å¥ˆäºšå­éƒ¨ç½²èµ·æ¥ä¹‹å‰çš„å¤šå¼ å›¾çš„æ¶ˆæ¯ï¼Œä¼šå› ä¸ºæ²¡æœ‰åœ¨ D1 æ•°æ®åº“ä¸­æ‰¾åˆ°å¯¹åº”çš„ media_group_id è€Œæ— æ³•åŒæ­¥åˆ° xLog ä¸Šã€‚åé¢ä¼šè€ƒè™‘å¼„ä¸€ä¸ªåŒæ­¥å†å²æ¶ˆæ¯çš„è„šæœ¬

```bash
wrangler d1 create tg
```

ç„¶åå°†è¿”å›çš„ D1 æ•°æ®åº“çš„åç§°å¡«å…¥åˆ° `wrangler.toml` ä¸­ï¼Œå°†æˆ‘é…ç½®æ–‡ä»¶ä¸­çš„ database_id æ”¹æˆä½ çš„ D1 æ•°æ®åº“ id

```toml
[[d1_databases]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "tg"
database_id = "******"
```

åˆ›å»ºæ•°æ®åº“è¡¨
  
```bash
wrangler d1 execute tg --file=./schema.sql
```

### éƒ¨ç½²åˆ° cloudflare worker

å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œå°±å¯ä»¥å°† Nyaruko éƒ¨ç½²åˆ° Cloudflare Workers ä¸Šäº†ã€‚

```bash
$ wrangler deploy
  ...
Total Upload: 708.54 KiB / gzip: 123.26 KiB
Uploaded nyaruko-telegram-bot (3.10 sec)
Published nyaruko-telegram-bot (0.44 sec)
  https://your-worker.your-name.workers.dev/"
Current Deployment ID: ***
  ...
```

### è®¾ç½®å¥ˆäºšå­çš„ Webhook

å°†å¥ˆäºšå­çš„ Webhook è®¾ç½®ä¸ºæ‚¨ Cloudflare Workers åœ°å€ï¼Œä¾‹å¦‚ï¼š

```bash
curl -F "url=https://your-worker.your-name.workers.dev/" https://api.telegram.org/bot<TELEGRAM_BOT_SECRET>/setWebhook
```

å±Šæ­¤ï¼ŒNyaruko æœºå™¨äººå·²ç»éƒ¨ç½²å®Œæˆï¼Œæ‚¨å¯ä»¥åœ¨ Telegram ä¸Šè¿›è¡Œæµ‹è¯•äº†ã€‚

### å¥ˆäºšå­çš„å‘½ä»¤æ³¨å†Œ (å¯é€‰)

æ‰¾åˆ° botfatherï¼Œç„¶åè¾“å…¥ `/setcommands`ï¼Œç„¶åé€‰æ‹©ä½ çš„æœºå™¨äººï¼Œç„¶åè¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

```bash
sync_twitter - Sync msg to Twitter.
sync_xlog - Sync msg to Twitter.
ping - Test if the bot is online.
getchatid - Get the ID of the current chat.
getuserid - Get the ID of the current user.
```

## å¥ˆäºšå­çš„å°ç§˜å¯†

Nyaruko çš„åå­—æ¥æºäºæ—¥æœ¬è½»å°è¯´ã€Šæ½œè¡Œå§ï¼å¥ˆäºšå­ã€‹ï¼Œå¥³ä¸»è§’å¥ˆäºšå­æ˜¯ä¸€ä½ç§¯æå‘ä¸Šã€å……æ»¡æ´»åŠ›çš„å…‹è‹é²ç¥ç§˜ç”Ÿç‰©ï¼Œå¥¹çš„å½¢è±¡æ˜¯æ ¹æ®å…‹è‹é²ç¥è¯ä¸­çš„å°¼äºšæ‹‰æ‰˜ææ™®å¡‘é€ çš„ã€‚åœ¨ Nyaruko æœºå™¨äººä¸­ï¼Œå®ƒä»£è¡¨äº†æ™ºèƒ½ä¸æ´»åŠ›çš„è±¡å¾ï¼Œä¸ä»…åŠ©åŠ› Niracler å¤„ç†ä¿¡æ¯ï¼Œè¿˜å¸¦ç€ç‚¹äºŒæ¬¡å…ƒçš„è¶£å‘³ï¼Œä¸ºç”Ÿæ´»æ·»å½©ï¼ğŸŒˆ

ğŸ‰ ç¥æ‚¨å’Œ Nyaruko æœ‰ç€æ„‰å¿«çš„äº¤æµä¸åˆä½œï¼å¦‚æœæ‚¨å¯¹ Nyaruko æœ‰ä»»ä½•å»ºè®®ï¼Œæ¬¢è¿ä¸æˆ‘ä»¬å–å¾—è”ç³»ï¼Œæˆ‘ä»¬ä¸º Nyaruko çš„æˆé•¿å’Œè¿›æ­¥ä¿æŒç€å¼€æ”¾çš„å¿ƒæ€å’Œçƒ­å¿±çš„æ¬¢è¿ï¼ğŸ’Œ
